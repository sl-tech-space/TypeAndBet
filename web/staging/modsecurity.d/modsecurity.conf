# ModSecurity 3.0 基本設定（ベストプラクティス）
SecRuleEngine On
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# ログ設定
SecAuditEngine On
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/nginx/modsec_audit/

# ルール設定
SecDefaultAction "phase:2,log,auditlog,pass"

# セキュリティルール
SecRule ARGS "@detectSQLi" \
    "id:1001,phase:2,t:none,log,deny,status:403,msg:'SQL Injection detected'"

SecRule ARGS "@detectXSS" \
    "id:1002,phase:2,t:none,log,deny,status:403,msg:'XSS attack detected'"

# レート制限
SecRule &ARGS "@gt 100" \
    "id:1003,phase:1,t:none,log,deny,status:429,msg:'Too many arguments'"

# ファイルアップロード制限
SecRule FILES_TMPNAMES "@contains /tmp/" \
    "id:1004,phase:2,t:none,log,deny,status:403,msg:'Invalid file upload'"

# ヘッダーインジェクション対策
SecRule REQUEST_HEADERS "@detectSQLi" \
    "id:1005,phase:1,t:none,log,deny,status:403,msg:'Header injection detected'"

# セッションハイジャック対策
SecRule &SESSIONID "@eq 0" \
    "id:1006,phase:1,t:none,log,deny,status:403,msg:'Session hijacking attempt'"

# エラーページ設定
SecRule REQUEST_URI "@contains /error" \
    "id:1007,phase:1,t:none,log,allow,msg:'Error page access'"

# ヘルスチェック除外
SecRule REQUEST_URI "@contains /health" \
    "id:1008,phase:1,t:none,log,allow,msg:'Health check'"

# 静的ファイル除外
SecRule REQUEST_URI "@contains /_next/static" \
    "id:1009,phase:1,t:none,log,allow,msg:'Static files'"

# ログレベル設定
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 3

# パフォーマンス最適化設定（ModSecurity 3.0対応）
SecRuleEngineDetectionOnly Off
SecResponseBodyAccess Off
SecResponseBodyLimit 524288
SecResponseBodyMimeType text/plain text/html text/xml

# ゲーム用の基本設定
SecAction "id:1000,phase:1,t:none,setvar:tx.game_mode=1,log,pass,msg:'Game mode enabled'"
SecAction "id:1001,phase:1,t:none,setvar:tx.session_timeout=3600,log,pass,msg:'Game session timeout set to 1 hour'"

# 設定ファイルの読み込み（ベストプラクティス）
Include /etc/modsecurity.d/exclusions.conf
Include /etc/modsecurity.d/rules.conf
